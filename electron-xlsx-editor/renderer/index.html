<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8" />
  <meta http-equiv="Content-Security-Policy"
    content="default-src 'self'; script-src 'self'; style-src 'self' 'unsafe-inline';" />
  <title>xlsx Editor</title>
  <link rel="stylesheet" href="./styles/app.css" />
  <link rel="stylesheet" href="./styles/agent.css" />
  <!-- x-data-spreadsheet CSS -->
  <link rel="stylesheet" href="../node_modules/x-data-spreadsheet/dist/xspreadsheet.css" />
</head>

<body>
  <!-- ===== Toolbar ===== -->
  <div id="toolbar">
    <div class="toolbar-group">
      <button id="btn-open" class="toolbar-btn" title="打开文件 (Ctrl+O)">📂 打开</button>
      <button id="btn-save" class="toolbar-btn" title="另存为 (Ctrl+Shift+S)">💾 另存为</button>
    </div>


    <div class="toolbar-group">
      <button id="btn-pull" class="toolbar-btn sync-btn" title="从服务端拉取数据" disabled>⬇ 拉取</button>
      <button id="btn-push" class="toolbar-btn sync-btn" title="推送数据到服务端" disabled>⬆ 推送</button>
      <button id="btn-settings" class="toolbar-btn" title="设置">⚙ 设置</button>
    </div>
    <div class="toolbar-separator"></div>
    <div class="toolbar-group">
      <button id="btn-agent-toggle" class="toolbar-btn agent-toggle-btn" title="AI 自动填写">🤖 AI 填写</button>
    </div>
  </div>

  <!-- ===== Drop overlay ===== -->
  <div id="drop-overlay">
    <div class="drop-message">📄 拖放 .xlsx / .xls 文件到这里</div>
  </div>

  <!-- ===== Main content area (spreadsheet + agent panel) ===== -->
  <div id="main-content">
    <div id="spreadsheet-container"></div>

    <!-- ===== Agent Side Panel ===== -->
    <aside id="agent-panel" hidden>
      <div class="agent-panel-header">
        <span>🤖 AI 填写助手</span>
        <button id="btn-agent-close" class="agent-close-btn" title="关闭">✕</button>
      </div>

      <!-- Config section (collapsible) -->
      <div class="agent-section">
        <button id="btn-agent-config-toggle" class="agent-section-toggle">⚙ 配置 <span
            class="toggle-arrow">▸</span></button>
        <div id="agent-config-body" class="agent-config-body collapsed">
          <label class="agent-label">API Base URL</label>
          <input id="agent-base-url" type="text" class="agent-input" placeholder="https://api.openai.com（或含 /v1）" />
          <label class="agent-label">模型名称</label>
          <input id="agent-model" type="text" class="agent-input" placeholder="gpt-4o / deepseek-chat / qwen-plus …" />
          <label class="agent-label">API Key</label>
          <input id="agent-api-key" type="password" class="agent-input" placeholder="sk-..." />
          <label class="agent-label">System Prompt（追加）</label>
          <textarea id="agent-system-prompt" class="agent-textarea" rows="3" placeholder="可选：追加业务说明"></textarea>
          <div class="agent-config-actions">
            <button id="btn-agent-save-config" class="agent-btn-primary">保存配置</button>
            <button id="btn-agent-test" class="agent-btn-secondary">验证</button>
          </div>
          <span id="agent-config-saved" class="agent-save-tip" hidden>✓ 已保存</span>
          <div id="agent-test-result" class="agent-test-result" hidden></div>
        </div>
      </div>

      <!-- Input section -->
      <div class="agent-section">
        <label class="agent-label">自然语言输入</label>
        <textarea id="agent-user-input" class="agent-textarea" rows="6"
          placeholder="描述要填入的内容，支持多行长文本，例如：伍家区南湾5-86号门前 FTTH1号光分路器，末级OBD设备光路子编码 E1603090113，主纤光缆断"></textarea>
        <button id="btn-agent-parse" class="agent-btn-primary">解析 →</button>
        <span id="agent-parse-loading" hidden>⏳ 解析中…</span>
        <!-- 解析进度条（解析中显示） -->
        <div id="agent-progress-wrap" class="agent-progress-wrap" hidden>
          <div class="agent-progress-label">
            <span id="agent-progress-status">正在连接…</span>
            <span id="agent-progress-pct" class="pct">0%</span>
          </div>
          <div class="agent-progress-bar-track">
            <div id="agent-progress-fill" class="agent-progress-bar-fill"></div>
          </div>
        </div>
        <div id="agent-error" class="agent-error" hidden></div>
      </div>

      <!-- Preview section -->
      <div class="agent-section" id="agent-preview-section" hidden>
        <div class="agent-preview-header">
          <label class="agent-label">预览结果</label>
          <span id="agent-preview-count" class="agent-preview-count"></span>
        </div>
        <div id="agent-preview" class="agent-preview"></div>
        <div class="agent-preview-actions">
          <button id="btn-agent-write" class="agent-btn-primary">写入表格</button>
          <button id="btn-agent-cancel" class="agent-btn-secondary">取消</button>
        </div>
      </div>
    </aside>
  </div>

  <!-- ===== Settings Modal ===== -->
  <div id="modal-settings" class="modal hidden">
    <div class="modal-box">
      <h3>⚙ 设置</h3>
      <label>API Endpoint URL</label>
      <input id="cfg-endpoint" type="text" placeholder="https://example.com/api/data" />
      <label>Authorization Token（可选）</label>
      <input id="cfg-token" type="text" placeholder="Bearer token..." />
      <label>请求超时（毫秒）</label>
      <input id="cfg-timeout" type="number" value="30000" min="1000" />
      <div class="modal-actions">
        <button id="cfg-save" class="btn-primary">保存</button>
        <button id="cfg-cancel" class="btn-secondary">取消</button>
      </div>
    </div>
  </div>

  <!-- ===== Error Modal ===== -->
  <div id="modal-error" class="modal hidden">
    <div class="modal-box">
      <h3>⚠ 错误</h3>
      <p id="modal-error-msg"></p>
      <div class="modal-actions">
        <button id="modal-error-close" class="btn-primary">关闭</button>
      </div>
    </div>
  </div>

  <!-- ===== Toast ===== -->
  <div id="toast" class="toast hidden"></div>

  <!-- Scripts (loaded after DOM) -->
  <script src="../node_modules/x-data-spreadsheet/dist/xspreadsheet.js"></script>
  <script src="../node_modules/axios/dist/axios.min.js"></script>
  <script src="../node_modules/xlsx/dist/xlsx.full.min.js"></script>
  <script src="./modules/importer.js"></script>
  <script src="./modules/exporter.js"></script>
  <script src="./modules/syncer.js"></script>
  <script src="./modules/toolbar.js"></script>
  <script src="./modules/agent-panel.js"></script>
  <script src="./renderer.js"></script>
</body>

</html>